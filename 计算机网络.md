## 互联网的组成

+ 边缘部分

  + 客户-服务器方式（C/S方式)

    主要是由客户端和服务端组成，他们之间的通信指的是两个进程之间的通信。他们的关系是服务被服务的关系，客户端主动发送请求，服务端被动接受请求，客户端与服务端建立通信之后，他们之间的通信是相互的，客户端与服务端之间可以互相发送或者接受请求。

  + 对等方式(P2P方式)

    对等方式指的是两台计算机系统进行平等的交流，他们之间没有客户端与服务端的区别，可以互相读取对方硬盘上的数据，其本质还是一个客户-服务器方式的通信。

+ 核心部分

  核心部分由大量的主机实现连通性，起特殊作用的是路由器，路由器是实现分组构建的关键部件。其任务是接收到转发的分组。

  + 电路交换

    电路交换的特点是占用通信资源->一直占用通信资源->归还通信资源，这种交换方式效率很低，实现任何两台计算机之间的通信成本太大。

  + 分组交换

    分组交换是采用存储转发的一种放方式，我们将要传输的整体数据叫做报文，然后，我们将报文分为许多个部分，叫做分组，在每个分组加上一些控制信息(首部）进行数据的传输，最终将接收到的分组拼接而原始数据。互联网的核心是由许多路由器组成的，主机是用来处理数据，而路由器是传输数据，进行分组的转发。即进行分组交换的。路由器的使用实现了互联网的高速地通信。如果将单个互联网简化为一个链路，那么路由器就是这个链路的结点。这种传输方式如果在数据中出现传输障碍的话，更具协议会选择最适合的路径，保证了传输的高效。分组在哪个部分进行传输，那么这个就占用那个信道的资源。但是由于分组需要进行排队等待传输，所以会造成一定的时延。

  + 报文交换

    报文交换类似于分组交换，但是不如分组交换那样速度快。将报文先传送到相邻的结点，然后进行存储查找转发表，转发到下一个结点。





## 网络层

### 互联网的路由选择协议

#### 内部网关协议RIP

+ 从路由器到直接来连接的网络的距离定义为1.
+ RIP协议的距离为跳数。最多只能包包含15个路由器，所以这是一种小型网络协议。
+ RIP协议开销较小，传输快。
+ RIP金和相邻路由器交换信息，路由器交换信息是和当前自己的路由表上的路由交换信息，同时按照固定的时间间隔和交换路由信息学。
+ 好消息传播快，坏消息传播慢。

#### OSPF协议（开放最短路优先)

+ 向本自治系统的所有路由器发送信息。这也叫做泛洪法。
+ 只有当链路状态发生改变时，路由器才向所有的路由器用泛洪法。

#### 外部网关协议BGP

#### IPV6

+ IPV6将首部长度变成固定的40字节。称为基本首部。
+ 取消了首部的检验字段。
+ IPV6数据包的目的地址可以说单播，多播和任播三种。
+ ipv6和ipv4的比较
  + 取消了首部长度字段
  + 取消了服务类型字段
  + 取消了总长度字段
  + 取消了标识，标志和片偏移字段
  + 把TTL字段改成条数限制字段
  + 取消了协议字段
  + 取消了检验和字段
  + 取消了选项字段
+ IPV6向IPV4的过渡
  + 使用双协议栈，双协议栈是指在协议传输到某一个字段的时候进行协议的转换，但是会造成部分数据的缺失。
  + 使用隧道协议，该协议是在原数据包的基础上套另一个协议，然后通过该种协议进行数据的传输。

#### 网际协议IP

+ 第4个版本IPv4和第6个版本IPv6
+ 与IP协议配套的协议：
  + 地址解析协议(ARP);
  + 网际控制报文协议(ICMP);
  + 网际组管理协议(IGMP)
+ IP地址及其表示方法
  + IP地址一般由两个字段组成：IP地址=网络号+主机号
    + 网络号，表示的是主机或路由器所连接的网络。网络号是唯一的。
    + 主机号，主机号标志着主机或者路由器。
  + IP地址分为A，B，C，D，E五类地址。其中A，B，C是单播地址。
  + 总长一共4个字节，其中A，B，C的网络号分别占1，2，3个字节，主机号分别占3,2,1个字节。
  + A类地址的网络号只有一个字节，其中的7位可以使用，第一位默认为0.网络号全为0的地址是一个保留地址，表示的是本网络，全1的是作为本地软件测试的回环地址，用于本主机的进程之间的通信。整个A类地址的空间占IP地址的50%。
  + B类地址的网络号占两个字节，其中前两位已经固定下来，为1,0。整个B类地址的空间占IP地址的25%。
  + C类地址的网络号占三个字节，其中前三位确定下来了，分别为1 1 0.还有21位可以进行分配。整个C类地址占IP地址空间为12.5%
  + IP地址是指网络应用层以上使用的地址，而物理地址是在运输层和数据链路层使用的地址。
+ 地址解析协议ARP
  + 作用是从网络层使用的IP协议，解析出在数据链路层使用的硬件地址。通过在主机ARP高速缓存中存放一个从IP协议到硬件地址的映射表，并且这个映射表还经常动态更新。
  + ARP把已经得到的地址映射放到高速缓存里面，这样就是得主机下次再和具有相同的目的地址的主机通行的时候，可以直接从高速缓存里面中找到所需要的硬件地址而不必再以广播的方式发送ARP请求分组。
  + 注意要在同一个局域网下面。
+ IP数据包的格式
  + 首部固定部分中的各字段。
    + 版本，首部长度，区分服务，总长度，标识，标志，片偏移，生存时间，协议，首部检验和，源地址，目的地址。



#### 划分子网和构造超网

+ 划分子网
  + IP地址的空间利用率有时很低，而且二级地址不太灵活，所以，可以对二级IP进行划分，变成三级IP。这种方法叫做划分子网。
  + 划分子网使得二级IP变成三级IP地址。IP地址=网络号+子网号+主机号
  + 路由器收到iP数据包之后，根据目的网络号和子网号找到目的子网，把IP数据报交付给目的主机。
+ 子网掩码
  + 子网掩码是为了在IP数据包的首部看书援助基或者目的主机所连接的网络是否进行了子网的划分。
  + 划分子网增加了灵活性，但是却减少了能够连接在网络上的主机总数。
+ 使用子网时的分组转发，子网划分之后，路由表里面必须要包含目的网络地址，子网掩码和下一跳地址。
+ 无分类编址CIDR(构造超网)
  + 网络前缀
    + CIDR消除了传统的A类，B类和C类地址以及划分子网的概念，更加有效地分配了IPv4的地址。回到了二级地址，也就是IP地址=网络前缀+主机号。
    + 在IP地址后面加上/，表示的是网络前缀所占的位数。
    + CIDR把网络前缀相同的连续IP组成一个CIDR地址块。
    + 斜线标记法中，后面的数字表示的是地址掩码中1的个数。
  + 最长前缀匹配

#### 网际控制报文协议ICMP

+ 有效地转发IP数据报和提高交付成功的机会。
+ ICMP差错报文和ICMP询问报文
  + 差错报文：重点不可达，时间超时，参数问题，改变路由（重定向)，就这四种报文。
  + 询问报文：回送请求和回答，时间戳请求和回答。

## 运输层

#### 概述

+ 运输层是端到端的通信，这里的端是程序在运行的时候暴露的端口。
+ 传输层提供了TCP和UDP两种传输协议
  + TCP是面向连接的，可靠的传输协议，将报文分为多个字段进行传输。有流量控制，无丢失，无重复，按序交付。
  + UDP协议是无连接的，不可靠的协议。无流量控制，有丢失，有重复，可能存在失序的情况。

#### 运输层的端口

+ 端口号是相对本地而言的，端口是为了标记计算机进程，端口只是对本地有意义。
+ 默认的端口是80端口
+ 发送方让应用层的各种引用进程都能将其数据通过端口向下交付给运输层。
+ 接收方那该让运输层知道应当将其报文段中的数据向上通过端口交付给引用层相应的进程。
+ 端口的范围一般为0-65535,其中熟知的端口号一般为0-1023,登记的端口号为:1024-49151,客户端口号或者短暂端口号为:49151-65535

#### UDP(用户数据报)协议

+ 由数据字段和首部字段组成
  + 首部字段为远端口，目的端口，长度和检验和。

#### 传输控制协议TCP

+ 特点
  + TCP的主要特点是面向连接的运输层协议。
  + 每个TCP连接只能有两个端点，是点对点连接。
  + TCP提供可靠交付，无差错，不丢失，不重复。
  + TCP提供全双工通信，通信双方可以同时发送数据和接收数据。
  + 面向字节流，流是进程流向进程的字节序列。

#### TCP报文首部格式

+ TCP分为首部和数据两部分。TCP的功能体现在它的首部字段。
  + 源端口和目的端口，各占两个字节。
  + 序号，占四个字节。TCP中的每个字节都是按照字节进行编号的。最多是4G
  + 确认号，占用四个字节。期望收到对方下一个报文段的第一个数据字节的序号
  + 数据偏移，占四位。
  + 保留，为以后保留空间。
  + 紧急URG，发送应用告诉发送方的TCP有紧急的数据要传输。然后将这个数据放到数据的最前面，优先进行传输。
  + 确认ACK，ACK=1表示字段有效，否则无效。
  + 推送PUSH，当两个进程进行交互通信的时候，一端的应用进程希望在键入一个命令后立即能够收到对方的相应。也就是立马向上交付，交给上层应用。
  + 复位RST，RST=1,表示TCP连接出现严重的错误，需要进行复位。
  + 同步SYN，在连接建立的时候同步序号。
  + 终止FIN，释放一个连接。
  + 窗口，占两个字节。窗口值作为接收方让发送方设置其发送窗口的依据。可以用于流量的控制。
  + 检验和，占2字节，检验和字段检验的范围包括首部和数据这两部分。
  + 紧急指针，占两字节，当URG=1的时候，我们需要设置这个字段，指出了紧急数据的末尾在报文段的位置。
  + 选项
    + 最大报文长度MSS，主要是选取合适的传输数据的长度，过长或者过短都可能会造成多余的开销。TCP和IP的首部都是20个字节，如果不设置，那么就默认为556个字节。数据在TCP进行包装之后，传输到IP层的话还要加上IP数据报的首部20个字节。过短的话利用率较低，过长的话切割报文的开销增加。
    + 选择确认，明确告诉一端哪些数据未收到，可以减少接收到的数据的重复传输。

+ TCP的超时重传的选择
  + 两个时间之差就是报文段的往返时间RTT。TCP保留了RTT的一个加权平均往返时间RTT。
  + 超时重传时间RTO，一般要大于RTT。